# CT-CLIP Training - Ablation Study: SwiGLU Only

experiment:
  name: "ablation-swiglu-only"
  tags: ["ablation", "swiglu"]
  seed: 2025
  notes: "Ablation study: Flash Attention disabled, RMSNorm disabled, SwiGLU enabled"

data:
  webdataset_shards_train: /orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/train_subset_50/shard-{000000..000049}.tar
  webdataset_shards_val: /orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/val_subset_10/shard-{000000..000009}.tar
  shuffle_buffer_size: 100
  reports_train: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/radiology_text_reports/train_reports.csv"
  reports_valid: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/radiology_text_reports/validation_reports.csv"
  train_meta: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/metadata/train_metadata.csv"
  valid_meta: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/metadata/validation_metadata.csv"
  labels_train: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/multi_abnormality_labels/train_predicted_labels.csv"
  labels_valid: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/multi_abnormality_labels/valid_predicted_labels.csv"
  batch_size: 16
  num_workers: 4
  prefetch_factor: 1
  persistent_workers: true
  use_embedding: false
  embedding_dir: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/embedding/author_ckpt"

model:
  image_encoder:
    type: "CTViT"
    dim: 512
    codebook_size: 8192
    image_size: 480
    patch_size: 20
    temporal_patch_size: 10
    spatial_depth: 4
    temporal_depth: 4
    dim_head: 32
    heads: 8
    use_flash_attention: false   # ❌
    use_rms_norm: false           # ❌
    use_swiglu: true              # ✅

  text_encoder:
    type: "BiomedBERT"
    path: "/orange/xujie/liang.renjie/DATA/weights/BiomedVLP-CXR-BERT-specialized"
    do_lower_case: true

  clip:
    dim_image: 294912
    dim_text: 768
    dim_latent: 512
    extra_latent_projection: false
    use_mlm: false
    downsample_image_embeds: false
    use_all_token_embeds: false

training:
  max_epochs: 10
  max_steps: null
  learning_rate: 1.25e-6
  weight_decay: 0.01
  gradient_accumulation_steps: 1
  max_grad_norm: 0.5
  save_every_n_epochs: 0.5
  save_every_n_steps: null
  warmup_epochs: null
  warmup_steps: 300
  min_lr_ratio: 0.01

validation:
  eval_every_n_epochs: 0.5
  eval_every_n_steps: null
  eval_samples: null
  metrics: ["auroc", "auprc", "f1", "precision", "recall"]
  use_bootstrap: false
  threshold: 0.5

checkpoint:
  save_dir: "./saves/ablation_swiglu_only"
  keep_last_n: 3
  save_best: true
  best_metric: "auroc"
  best_metric_mode: "max"

logging:
  use_wandb: true
  use_tensorboard: false
  use_console: true
  wandb:
    project: "ct-clip"
    entity: null
    mode: "online"
    group: "ablation-studies"
    job_type: "train"
  tensorboard:
    log_dir: "./runs"
  log_every_n_steps: 10
  profile_timing: false

device:
  use_cuda: true
  cuda_device: 0
