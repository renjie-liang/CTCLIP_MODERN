# CT-CLIP Debug Configuration
# Use this for debugging DataLoader issues

# 实验信息
experiment:
  name: "ct-clip-debug"
  tags: ["debug"]
  seed: 2025
  notes: "Debug configuration with minimal workers"

# 数据配置
data:
  # WebDataset format paths - PREPROCESSED data (no CPU processing needed)
  # All volumes are already preprocessed: resized, normalized, cropped to (480,480,240)
  webdataset_shards_train: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/train_preprocessed_webdataset/shard-{000000..000316}.tar"
  webdataset_shards_val: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/valid_preprocessed_webdataset/shard-{000000..000060}.tar"
  shuffle_buffer_size: 100  # Reduced for debugging

  reports_train: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/radiology_text_reports/train_reports.csv"
  reports_valid: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/radiology_text_reports/validation_reports.csv"

  train_meta: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/metadata/train_metadata.csv"
  valid_meta: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/metadata/validation_metadata.csv"

  labels_train: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/multi_abnormality_labels/train_predicted_labels.csv"
  labels_valid: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/multi_abnormality_labels/valid_predicted_labels.csv"

  # DataLoader配置 - OPTIMIZED FOR DEBUGGING
  batch_size: 4           # Small batch for debugging
  num_workers: 0          # Single process - easier to debug
  prefetch_factor: 2      # Ignored when num_workers=0
  persistent_workers: false  # Not used with num_workers=0
  use_embedding: false
  embedding_dir: "/orange/xujie/liang.renjie/DATA/dataset/CT-RATE/dataset/embedding/author_ckpt"

# 模型配置
model:
  # Image Encoder (CTViT)
  image_encoder:
    type: "CTViT"
    dim: 512
    codebook_size: 8192
    image_size: 480
    patch_size: 20
    temporal_patch_size: 10
    spatial_depth: 4
    temporal_depth: 4
    dim_head: 32
    heads: 8
    profile_timing: false  # Enable detailed CTViT profiling (print timing for each component)

  # Text Encoder (BiomedBERT)
  text_encoder:
    type: "BiomedBERT"
    path: "/orange/xujie/liang.renjie/DATA/weights/BiomedVLP-CXR-BERT-specialized"
    do_lower_case: true

  # CLIP配置
  clip:
    dim_image: 294912
    dim_text: 768
    dim_latent: 512
    extra_latent_projection: false
    use_mlm: false
    downsample_image_embeds: false
    use_all_token_embeds: false

# Training configuration (step-based)
training:
  max_steps: 100          # Only 100 steps for debugging
  learning_rate: 1.25e-6
  weight_decay: 0.01
  gradient_accumulation_steps: 1
  max_grad_norm: 0.5
  save_every_n_steps: 50  # Save more frequently

  # Learning rate scheduling
  warmup_steps: 10        # Short warmup for debugging
  min_lr_ratio: 0.01

# Validation configuration
validation:
  eval_every_n_steps: 50  # Validate more frequently
  eval_samples: 10        # Only 10 samples for speed
  metrics: ["auroc", "auprc", "f1", "precision", "recall"]
  use_bootstrap: false
  threshold: 0.5

# Checkpoint configuration
checkpoint:
  save_dir: "./saves_debug"
  keep_last_n: 2
  save_best: true
  best_metric: "auroc"
  best_metric_mode: "max"

# Logging configuration
logging:
  use_wandb: false        # Disable for debugging
  use_tensorboard: false
  use_console: true

  wandb:
    project: "ct-clip"
    entity: null
    mode: "offline"
    group: null
    job_type: "debug"

  tensorboard:
    log_dir: "./runs_debug"

  log_every_n_steps: 5    # Log every step
  profile_timing: true  # Print detailed timing breakdown (data loading, forward, backward, optimizer)

# Device configuration
device:
  use_cuda: true
  cuda_device: 0
